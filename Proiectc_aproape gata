#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <ctype.h>

struct date_format {
    int year, month, day;           // struct to store the date with year, month and day
};

int active_accounts = 0, num_accounts = 0, audit_length = 0;    // variables to hold how many accounts / audit logs there are
                                                                // active accounts for the case if we delete accounts to not have duplicates of iban

struct transaction_format {
    char type[20];
    float amount;
    char description[50];           // struct to hold transaction details
    char from_acc_iban[24];
    char to_acc_iban[24];
    struct date_format data;
};

struct contacts_format{
    char first_name[20];
    char second_name[20];       // struct to hold contacts detail
    char iban[24];

};
struct audit_log{
    char first_name[20];
    char second_name[20];
    char action[50];
    char transfer_from[20];             // struct to hold audit log details
    char transfer_to[20];
    char additional_description[30];
    struct date_format date;
    float amount;
};

struct audit_log auditLog[1000];    // initialize the audit log

struct account{
    int is_administrator;
    int number_of_friends;
    char first_name[20];
    char second_name[20];
    char password[30];              // struct to hold the account details
    char account_type[20];
    float balance;
    char iban[24];
    struct date_format user_birthday;
    struct transaction_format *transactions;
    struct contacts_format *contact;
    int number_of_transactions;
};

void print_menu()
{
    printf("What do you want to do? Please select one option of the following:\n");
    printf("1. Login\n");
    printf("2. Register\n");
    printf("3. Save from file\n");      // function to print the main functionalities for the user
    printf("4. Import from file\n");
    printf("5. Exit\n\n");
}

void add_to_audit_log(char first_name[], char second_name[], char action[], char additional_description[], char transfer_from[], char transfer_to[], float amount, struct date_format date)
{
    strcpy(auditLog[audit_length].first_name, first_name);
    strcpy(auditLog[audit_length].second_name, second_name);
    strcpy(auditLog[audit_length].action, additional_description);      // function to add a new log with all it's details
    strcpy(auditLog[audit_length].additional_description, action);
    strcpy(auditLog[audit_length].transfer_from, transfer_from);
    strcpy(auditLog[audit_length].transfer_to, transfer_to);
    auditLog[audit_length].date.year= date.year;
    auditLog[audit_length].date.month= date.month;
    auditLog[audit_length].date.day= date.day;
    auditLog[audit_length].amount = amount;
    audit_length++;                         // also update the length
}

int check_if_name(char name[], int length)      // function to verify if a name has the correct characters and length
{
    if (length < 3) {
        printf("The name must have a minimum of 3 letters!\n");     // verify it's length
        return 0;
    }

    if (name[0] < 'A' || name[0] > 'Z') {
        printf("The first character must be a capital letter!\n");      // verify if the name starts with a capital letter
        return 0;
    }

    for (int i = 1 ; i < length; i++) {
        if ((name[i] < 'a' || name[i] > 'z') && name[i] != ' ')         // verify if the name contains other characters than letter
        {
            printf("Only the first letter should be capital / other special characters are not accepted\n"); // print an error if yes
            return 0;
        }
    }
    return 1;
}

int calculate_year(const char *date)            // calculate the year from a given data string
{
    int year = (date[0] - '0') * 1000 + (date[1] - '0') * 100 + (date[2] - '0') * 10 + (date[3] -'0');  // we transform it into integer and return it
    return year;
}

//Function to transform from string to integer for the month of the transaction
int calculate_month(const char *date)
{
    int month = (date[5] - '0') * 10 + (date[6] - '0'); // we transform it into integer and return
    return month;
}

//Function to transform from string to integer for the day of the transaction
int calculate_day(const char *date)
{
    int day = (date[8] - '0') * 10 + (date[9] - '0');// we transform it into integer and return
    return day;
}

int is_date_valid(const char *date) // function to verify if a given string is a valid date
{
    if (strlen (date) != 10)    // we use the format YYYY-MM-DD , in total are 10 characters, if the input string has more or less than 10 characters then the input date is not valid
        return 0;

    if (date[7] != '-' || date[4] != '-') // we use '-' character to delimitate the year, month and day , if the characters '-' are not in the right places then the date is invalid
        return 0;

    int an = calculate_year(date);
    int luna = calculate_month(date); // we transform the date string into integers, so we can cancel the dates that don't exist more easily
    int zi = calculate_day(date);

    if ( an < 1000)     // we will not take into account the dates before the year 1000, because of the format YYYY
        return 0;


    if ( luna < 0 || luna > 12 )    // we cancel out the months that don't exist
        return 0;

    if ( (luna == 1 || luna == 3 || luna == 5 || luna == 7 || luna == 8 || luna == 10 || luna == 12) && zi > 31) // we cancel out the invalid dates for they months that have 31 days
        return 0;

    if ( (luna == 4 || luna == 6 || luna == 9 || luna == 11 ) && zi > 30) // we cancel out the invalid dates for they months that have 30 days
        return 0;

    if ( an % 4 == 0 && luna == 2 && zi > 29) // we cancel out the invalid date for the month of February in the bisect years
        return 0;

    if( an % 4 != 0 && luna == 2 && zi > 28) // we cancel out the invalid date for the month of February in the non-bisect years
        return 0;

    return 1;

}

//Function to compare 2 dates
int compare_dates(int year1, int month1, int day1, int year2, int month2, int day2) // compares the 2 dates , returns 1 if the first date is greater than the second one,
{                                                                                  // returns 0 if they are equal, return -1 if the second one is greater
    if(year1 > year2)   // first we compare the years
        return 1;

    if(year1 == year2 && month1 > month2) // if the years are equal , we verify the months
        return 1;

    if(year1 == year2 && month1 == month2 && day1 > day2) // if the years and months are equal , we verify the days now
        return 1;

    if(year1 == year2 && month1 == month2 && day1 == day2) // if the years , months and days are equal , then the two dates are equal
        return 0;

    return -1;  // if the previous conditions are not met then the second date is greater than the first date
}
//Function to verify if a given date is between two other given dates

int is_between_dates(int year1, int month1, int day1, int year2, int month2, int day2, int year_to_compare, int month_to_compare, int day_to_compare)
{                                                                                                       // returns 1 if year_to_compare,month_to_compare and day_to_compare is between year1, and year2,
    // between month1 and month2, and between day1 and day 2, it will return 0 otherwise
    if(compare_dates(year_to_compare, month_to_compare, day_to_compare, year1, month1, day1) == -1) // we compare the date we need to compare with the beginning date
        return 0;

    if(compare_dates(year_to_compare, month_to_compare, day_to_compare, year2, month2, day2) == 1) // we compare the date we need to compare with the end date
        return 0;

    return 1;                                                                                    // will return 1 if the given date is between the interval
}

//function to calculate the sum of the digits of a number
int calculate_sum_of_digits(int number)
{
    int sum = 0;
    while(number){
        sum = sum + number % 10;
        number = number / 10;
    }
    return sum;
}

//transform a given string into asterisk string(for the password)
void from_string_to_asterisk(char text[])
{
    for (int i = 0 ; i < strlen(text); i++)
        printf("*");
}

//function to print the details of an account
void account_details(struct account *accounts,int account_index)
{
    //printf("%d", accounts[account_index].user_birthday.year);

    printf("-----This is your account-----\n");         // print some messages and diverse details about the account, userbirthday, balance, names etc.

    if(strcmp(accounts[account_index].account_type, "Savings") == 0)
        printf("You have a savings account before doing a transaction you will get 2 percent of your balance!\n");

    if(strcmp(accounts[account_index].account_type, "Credit") == 0)
    {
        printf("You have a credit account so you can go below 0 balance, with a maximum amount you can borrow money from us, but also only for withdrawals and payments!\n");
        printf("You can borrow a maximum of %d money\n", (2024 - accounts[account_index].user_birthday.year) * 100 + accounts[account_index].user_birthday.month * 50);
    }

    if(accounts[account_index].is_administrator == 1)
        printf("    You are an administrator\n");

    printf("    First name: %s\n", accounts[account_index].first_name);
    printf("    Last name: %s\n", accounts[account_index].second_name);

    printf("    Your birthday is : %d/%d/%d\n", accounts[account_index].user_birthday.day, accounts[account_index].user_birthday.month, accounts[account_index].user_birthday.year);
    printf("    Password:");
    from_string_to_asterisk(accounts[account_index].password);
    printf("\n");

    printf("    Your iban: %s\n", accounts[account_index].iban);

    printf("    Your current balance is: %f RON\n", accounts[account_index].balance);

    printf("-----------------------------------\n");
}

//function to print the possible things the user can do with his account
void print_user_options()
{
    printf("What do you want to do?\n");
    printf("1. View account details\n");
    printf("2. Make a transaction\n");
    printf("3. View balance\n");
    printf("4. Edit account\n");                    // print the options
    printf("5. Delete account\n");
    printf("6. Financial report between 2 dates\n");
    printf("7. View transaction history\n");
    printf("8. View list of contacts\n");
    printf("9. Add a contact\n");
    printf("10. Delete a contact\n");
    printf("11. Transfer money to a contact\n");
    printf("12. Log out\n");

}

//function to print the edit account menu
void print_edit_account_menu()
{
    printf("What do you want to change about your account?\n");
    printf("1. First name\n");
    printf("2. Last name\n");
    printf("3. Birthday date\n");       // print the options
    printf("4. Password\n");
    printf("5. Exit\n");


}

// function to verify if char is a float number
int verify_if_double(const char *money)    // will return -1 if the given is not a double type number
{
    int length = strlen(money);        // we take the length of the string

    int decimal_point = 0;            // in the decimal_point variable we hold how many decimal points ('.') we have in the string

    for ( int i = 0 ; i < length ; i++) // we go through the string
    {
        char character = money[i];          // we take each character and verify some conditions

        if (character == '.')        // if we meet a dot('.') we increase the value of the decimal points
        {
            decimal_point++;
        }

        if(decimal_point == 2)      // if we meet a second dot('.') there is no point in continuing the search , a double type variable has only one dot in it's composition(e.g. 3.14)
            return -1;              // so we return -1

        if((character < '0' || character > '9') && character != '.') // if there are other characters than numbers or dot('.') in the user input, then the number has not been introduced correctly
            return -1;                                              // so we return -1
    }
    return 0;                   // if the previous conditions are not met then the number has been correctly introduced
}

//function to print the types of accounts the user can have
void print_transaction_type()
{
    printf("What kind of transaction you want to do?\n");
    printf("1. Deposit\n");
    printf("2. Withdraw\n");                                // print the options
    printf("3. Transfer\n");
    printf("4. Payment\n");

}

// function to calculate of the account
float calculate_balance(struct account *accounts, int account_index)
{
    float balance = 0;     // initialize the balance

    for ( int i = 0 ; i < accounts[account_index].number_of_transactions ; i++)     // go through all the transaction
    {
        if(strcmp(accounts[account_index].transactions[i].type, "Deposit") == 0)                     // determine the type of transaction
            balance = balance + accounts[account_index].transactions[i].amount;
        else
        if(strcmp(accounts[account_index].transactions[i].type, "Withdraw") == 0)                 // if it's a withdraw, Transfer-, Payment substract it from the balance
            balance = balance -  accounts[account_index].transactions[i].amount;
        else                                                                                       //if it is a Deposit, Transfer+ , Interest Rate add it to the balance
            if(strcmp(accounts[account_index].transactions[i].type, "Transfer-") == 0)
                balance = balance -  accounts[account_index].transactions[i].amount;
            else if(strcmp(accounts[account_index].transactions[i].type, "Transfer+") == 0)
                balance = balance + accounts[account_index].transactions[i].amount;
            else if(strcmp(accounts[account_index].transactions[i].type, "Payment") == 0)
                balance = balance - accounts[account_index].transactions[i].amount;
            else if(strcmp(accounts[account_index].transactions[i].type, "Interest Rate") == 0)
                balance = balance + accounts[account_index].transactions[i].amount;

    }
    return balance;         // return the balance
}

//Function to add transaction
void add_transaction(struct account *accounts, int account_index)
{
    struct transaction_format new_transaction;   // we initialize a new transaction

    while(1){
        char date[11];
        printf("Enter the date of the transaction (format YYYY-MM-DD)\n"); // we ask the user to introduce a date
        scanf("%s", date);

        if(is_date_valid(date) == 1)
        {
            if(calculate_year(date) - accounts[account_index].user_birthday.year >= 0){
                new_transaction.data.day = calculate_day(date);
                new_transaction.data.month = calculate_month(date);                     // process the date
                new_transaction.data.year = calculate_year(date);
                break;
            }
            else {
                printf("You can't make transactions before you were born\n");       // print error for wrong input
                return;
            }
        }
        else
            printf("Please enter a valid date\n");  // print error for wrong input
    }

    printf("Enter the description:\n");         // ask the user to introduce a description of the transaction

    scanf(" %[^\n]s", new_transaction.description); // we read the description string until a new line is met

    char money[30];         // variable used for holding the input user , of the amount variable

    while(1)
    {
        printf("Enter the amount(will be considered only the first 2 digits of the number):\n"); // ask the user to insert the amount of the transaction

        scanf("%s", money);     // read the user input

        if(money[0] == '-')                                             // the amount cannot be negative , because we will take into account if it's a Income or expense later
            printf("The amount entered must be a positive number\n");
        else
        if(verify_if_double(money) == -1)                         // we verify if the input has been introduced correctly
            printf("Invalid input please enter a valid sum\n");  // repeat until the introduced value is correct
        else
            break;
    }

    new_transaction.amount = atof(money);   // we add the amount into the new structure with the atof function

    float amount = new_transaction.amount;

    int index = -1;


    while(1)
    {
        char input[100];        // variable used for holding the input user , of the type variable

        print_transaction_type(); // ask the for the user's input

        scanf("%s", &input);        // read the input

        if(strlen(input) > 1)       // verify if the command is valid , if not print error message
            printf("Invalid command. Please Please enter a number between 1 and 5\n");
        else{
            int option = input[0] - '0';

            if (option == 1) {          // if it's a deposit
                strcpy(new_transaction.type, "Deposit");                        // copy the details to the new transaction structure
                strcpy(new_transaction.from_acc_iban, accounts[account_index].iban);
                strcpy(new_transaction.to_acc_iban, "Yourself...");
            } else if (option == 2) {       // if it's a withdraw
                    if(strcmp(accounts[account_index].account_type, "Credit") == 0 && accounts[account_index].balance - new_transaction.amount > -((2024 - accounts[account_index].user_birthday.year) * 100 + accounts[account_index].user_birthday.month * 50))
                    {
                        strcpy(new_transaction.type, "Withdraw");       // if the account is the type of credit, the user can borrow money from the bank
                        printf("You will borrow money from us, and your balance will be under 0 are you sure?");
                        while (1) {
                            printf("1. Yes\n2. No\n");      // ask for confirmation
                            char input_afirmation[5];
                            scanf("%s", &input_afirmation);
                            if (strlen(input_afirmation) > 1)       // verify if the command is valid, if not print error message
                                printf("Invalid command.\n");
                            else {
                                int option1 = input_afirmation[0] - '0';
                                if (option1 == 1) {
                                    break;
                                } else {
                                    return;
                                }
                            }
                        }
                    }
                    else
                if (accounts[account_index].balance < new_transaction.amount) {     // if it is not a credit account verify if the user has enough money
                    printf("You don't have that much money in your account!\n");    // print error if not
                    return;
                } else {
                    strcpy(new_transaction.type, "Withdraw");       // if the account is type of savings, the user will be penalised
                    if (strcmp(accounts[account_index].account_type, "Savings") == 0) {
                        printf("This is a savings account. For each transaction you make we will take 5 percent of the transaction value! Are you sure you want to do that?\n");
                        while (1) {
                            printf("1. Yes\n2. No\n");      // ask for confirmation
                            char input_afirmation[5];
                            scanf("%s", &input_afirmation);
                            if (strlen(input_afirmation) > 1)       // verify if the command is valid, if not print error message
                                printf("Invalid command.\n");
                            else {
                                int option1 = input_afirmation[0] - '0';
                                if (option1 == 1) {
                                    new_transaction.amount = new_transaction.amount + (new_transaction.amount * 5) / 100; // update the amount of the transaction
                                    break;
                                } else {
                                    return;
                                }
                            }
                        }
                    }
                }
                strcpy(new_transaction.from_acc_iban, accounts[account_index].iban);        // update the new_transaction ibans
                strcpy(new_transaction.to_acc_iban, "0");
            } else if (option == 3) {           // if the user wants to make a transfer
                strcpy(new_transaction.type, "Transfer-");  // type "Transfer-" means that this user was the one to send the money else "Transfer+" means the user got the money
                printf("Please enter the iban you want to make the transfer to:\n");  // ask for the iban, where the user want to transfer the money
                char iban[24];
                scanf("%s", iban);  // read the iban
                for (int i = 0; i < active_accounts; i++) {

                    if (strcmp(iban, accounts[i].iban) == 0) {
                        index = i;                          // if we found the iban remember the index of the respective account
                        break;
                    }

                }
                //printf("%d", index);
                if(index == -1)     // if -1 means that the account doesn't exist
                {
                    printf("We did not find any account with this iban! Returning in the menu...\n"); // print error
                    return;
                }
                if (accounts[account_index].balance < new_transaction.amount) {  // check if the user has the money
                    printf("You don't have that much money in your account!\n"); // print error
                    return;
                } else {
                    if (strcmp(accounts[account_index].account_type, "Savings") == 0) { // if the user has an savings account ask for permition to take more money from him
                        printf("This is a savings account. For each transaction you make we will take 5 percent of the transaction value! Are you sure you want to do that?\n");
                        while (1) {
                            printf("1. Yes\n2. No\n");
                            char input_afirmation[5];
                            scanf("%s", &input_afirmation);
                            if (strlen(input_afirmation) > 1)       // verify if the command is valid, if not print error message
                                printf("Invalid command.\n");
                            else {
                                int option1 = input_afirmation[0] - '0';
                                if (option1 == 1) {
                                    new_transaction.amount = new_transaction.amount + (new_transaction.amount * 5) / 100;   // update the amount
                                    break;
                                } else {
                                    return;
                                }
                            }
                        }
                    }
                }
                strcpy(new_transaction.from_acc_iban, accounts[index].iban);        // create a new transaction for the account that receives the money with all the according details
                strcpy(new_transaction.to_acc_iban, accounts[account_index].iban);

                accounts[index].transactions[accounts[index].number_of_transactions].data = new_transaction.data;
                accounts[index].transactions[accounts[index].number_of_transactions].amount = amount;
                strcpy(accounts[index].transactions[accounts[index].number_of_transactions].description, new_transaction.description);
                strcpy(accounts[index].transactions[accounts[index].number_of_transactions].type, "Transfer+"); // fill in all the necesarry details
                strcpy(accounts[index].transactions[accounts[index].number_of_transactions].from_acc_iban, accounts[account_index].iban);
                strcpy(accounts[index].transactions[accounts[index].number_of_transactions].to_acc_iban, accounts[index].iban);
                accounts[index].number_of_transactions = accounts[index].number_of_transactions + 1;

                char action[50], description[30];
                strcpy(action, "Transaction");  // for the audit log , write the action and a brief description
                strcpy(description, "Transfer");

                add_to_audit_log(accounts[index].first_name, accounts[index].second_name, action, description, accounts[account_index].iban, accounts[index].iban, amount, new_transaction.data);
                                                                                                            // update the audit log
                accounts[index].balance = calculate_balance(accounts, index);

            }
            else if(option == 4)
            {       // if option is payment
                strcpy(new_transaction.type, "Payment");
                if(strcmp(accounts[account_index].account_type, "Credit") == 0 && accounts[account_index].balance - new_transaction.amount > -((2024 - accounts[account_index].user_birthday.year) * 100 + accounts[account_index].user_birthday.month * 50))
                {                                                               // for a credit account the user can borrow more money from us
                    strcpy(new_transaction.type, "Payment");
                    printf("You will borrow money from us, and your balance will be under 0 are you sure?");    // ask for confirmation
                    while (1) {
                        printf("1. Yes\n2. No\n");
                        char input_afirmation[5];
                        scanf("%s", &input_afirmation);
                        if (strlen(input_afirmation) > 1)       // verify if the command is valid, if not print error message
                            printf("Invalid command.\n");
                        else {
                            int option1 = input_afirmation[0] - '0';
                            if (option1 == 1) {
                                break;
                            } else {
                                return;
                            }
                        }
                    }
                }
                else
                if (accounts[account_index].balance < new_transaction.amount) {         // if it's not a savings account verify if the user has enough money
                    printf("You don't have that much money in your account!\n"); // print error
                    return;
                } else {
                    if (strcmp(accounts[account_index].account_type, "Savings") == 0) { // for savings account charge extra for transaction
                        printf("This is a savings account. For each transaction you make we will take 5 percent of the transaction value! Are you sure you want to do that?\n");
                        while (1) {
                            printf("1. Yes\n2. No\n");
                            char input_afirmation[5];
                            scanf("%s", &input_afirmation);
                            if (strlen(input_afirmation) > 1)       // verify if the command is valid, if not print error message
                                printf("Invalid command.\n");
                            else {
                                int option1 = input_afirmation[0] - '0';
                                if (option1 == 1) {
                                    new_transaction.amount = new_transaction.amount + (new_transaction.amount * 5) / 100; // update the amount
                                    break;
                                } else {
                                    return;
                                }
                            }
                        }
                    }
                }
            }

        }
        break;
    }

    if(strcmp(accounts[account_index].account_type, "Savings") == 0)        // if the account is a savings type saving the user will get 2% of their balance back before each transaction
    {
        accounts[account_index].transactions[accounts[account_index].number_of_transactions].data = new_transaction.data;   // add a new transaction as an "Interest Rate"
        accounts[account_index].transactions[accounts[account_index].number_of_transactions].amount = (accounts[account_index].balance * 2) / 100;
        strcpy(accounts[account_index].transactions[accounts[account_index].number_of_transactions].description, new_transaction.description);  // update all the necesary things
        strcpy(accounts[account_index].transactions[accounts[account_index].number_of_transactions].type, "Interest Rate");
        strcpy(accounts[account_index].transactions[accounts[account_index].number_of_transactions].from_acc_iban, "Bank"); // 1 means from the bank
        strcpy(accounts[account_index].transactions[accounts[account_index].number_of_transactions].to_acc_iban, accounts[account_index].iban);
        accounts[account_index].number_of_transactions = accounts[account_index].number_of_transactions + 1;
        accounts[account_index].balance = calculate_balance(accounts, account_index);
        char action[50];
        strcpy(action, "Transaction");
                                                                        // also update the audit log
        add_to_audit_log(accounts[account_index].first_name, accounts[account_index].second_name, action, new_transaction.type, new_transaction.from_acc_iban, new_transaction.to_acc_iban, new_transaction.amount, new_transaction.data);

    }

    accounts[account_index].transactions[accounts[account_index].number_of_transactions] = new_transaction;
    accounts[account_index].number_of_transactions = accounts[account_index].number_of_transactions + 1;        // add the new transaction to the account
    accounts[account_index].balance = calculate_balance(accounts, account_index);               // calculate the balance
    char action[50];
    strcpy(action, "Transaction");
    add_to_audit_log(accounts[account_index].first_name, accounts[account_index].second_name, action, new_transaction.type, new_transaction.from_acc_iban, new_transaction.to_acc_iban, new_transaction.amount, new_transaction.data);
    printf("The transaction was added successfully\n"); // let the user know that the new translation is registered

}

// function to edit the account details
void edit_account( struct account *accounts,int account_index)
{
    while (1) {
        print_edit_account_menu();
        char input[100];        // initialize the option

        printf("Enter your option\n");  // ask the user for input

        scanf("%s", &input);        // read the input

        if (strlen(input) > 1)       // verify if the command is valid , if not print error message
            printf("Invalid command. Please Please enter a number between 1 and 5\n");
        else {
            int option = input[0] - '0';        // transform the string of the option in integer

            switch (option) {
                case 1:
                    while (getchar() != '\n');
                    while(1) {
                        printf("Enter your new first name:\n"); // ask for the new name
                        char first_name[20];
                        scanf("%s", first_name);
                        if(check_if_name(first_name, strlen(first_name)) == 1)
                        {
                            strcpy(accounts[account_index].first_name, first_name);
                            break;
                        }
                    }
                    break;
                case 2:
                    while (getchar() != '\n');
                    while(1){
                        printf("Enter your new last name:\n");      // ask for the new name
                        char second_name[20];
                        scanf("%s", second_name);
                        if(check_if_name(second_name, strlen(second_name)) == 1)
                        {
                            strcpy(accounts[account_index].second_name, second_name); // update the field accordingly
                            break;
                        }
                    }
                    break;
                case 3:
                    while (getchar() != '\n');
                    while(1){
                        char date[11];
                        printf("Enter your new birthday (format YYYY-MM-DD)\n"); // we ask the user to introduce a date
                        scanf("%s", date);

                        if(is_date_valid(date) == 1)
                        {
                            if(2024 - calculate_year(date) > 18 || 2024 - calculate_year(date) == 18 && calculate_month(date) == 1 && calculate_day(date) <= 4){
                                accounts[account_index].user_birthday.day = calculate_day(date);
                                accounts[account_index].user_birthday.month = calculate_month(date);        // update the date
                                accounts[account_index].user_birthday.year = calculate_year(date);
                                break;
                            }
                            else {
                                printf("You must be 18 to have a bank account\n");
                                return;
                            }
                        }
                        else
                            printf("Please enter a valid birthday\n");
                    }
                    break;
                case 4:
                {
                    while (getchar() != '\n');

                    int num_attempts = 0;
                    while(1) {
                        if (num_attempts == 5) {        // before switching the password ask the user old password
                            printf("How have you logged in? Already forgot your password? You are a robot! You made too many mistakes entering your password. ACCESS DENIED!!!\n");
                            return;                                     // if it writes it wrongly multiply times print error exit the function
                        }
                        printf("Enter your password:");     // ask for password
                        char input_password[30];
                        fgets(input_password, 30, stdin);
                        if (strcmp(accounts[account_index].password, input_password) == 0) {        // if the password is correct
                            while(1){
                                printf("Enter your password\n");
                                char password[30];
                                fgets(password, 30, stdin);
                                int capital = 0, special = 0, normal = 0, spaces = 0;
                                if(strlen(password) < 5 || strlen(password) > 30)
                                    printf("The length of the password must be between 5 and 30!\n");       // ask for the new one
                                else {
                                    for (int i = 0; i < strlen(password); i++) {                        // respecting the bank formula for a password
                                        if (password[i] >= 'a' && password[i] <= 'z')
                                            normal++;
                                        else if (password[i] >= 'A' && password[i] <= 'Z')
                                            capital++;
                                        else if (password[i] == ' ')
                                            spaces++;
                                        else
                                            special++;
                                    }
                                    if (special == 0 || normal == 0 || capital == 0 || spaces > 0)
                                        printf("The password must contain at least one capital letter, one lower case letter, one special character and must not contain spaces\n");
                                    else {                                                                                      // print error
                                        strcpy(accounts[account_index].password, password); //update the password
                                        break;
                                    }
                                }
                            }

                            return;
                        } else {
                            num_attempts++;
                            printf("Wrong password! You have %d attempts left\n", 5 - num_attempts);
                        }
                    }
                    break;
                }
                case 5:
                    return;
                default:
                    printf("Invalid input\n"); // print error
            }
        }
    }
}

// function that deletes an account and frees the occupied memory
void change_accounts(struct account *accounts, int account_index) {

    struct date_format new_date;
    new_date.year = 2024;
    new_date.month = 1;
    new_date.day = 9;

    char action[50];
    strcpy(action, "Deleted account");
                                                        // update the audit log
    add_to_audit_log(accounts[account_index].first_name, accounts[account_index].second_name, action, "0", "0", "0", 0, new_date);

    strcpy(accounts[account_index].iban, accounts[active_accounts].iban);
    strcpy(accounts[account_index].password, accounts[active_accounts].password);
    strcpy(accounts[account_index].second_name, accounts[active_accounts].second_name);
    accounts[account_index].balance = accounts[active_accounts].balance;
    accounts[account_index].is_administrator = accounts[active_accounts].is_administrator;                  // the account on the last index, have it at the account's index we need to delete
    accounts[account_index].number_of_transactions = accounts[active_accounts].number_of_transactions;
    accounts[account_index].number_of_friends = accounts[active_accounts].number_of_friends;
    accounts[account_index].user_birthday.month = accounts[active_accounts].user_birthday.month;
    accounts[account_index].user_birthday.day = accounts[active_accounts].user_birthday.day;
    accounts[account_index].user_birthday.year = accounts[active_accounts].user_birthday.year;

    // Allocate memory for transactions
    accounts[account_index].transactions = malloc(100 * sizeof(struct transaction_format));         // allocate new memory for the respective function

    // Copy data to transactions
    for (int i = 0; i < accounts[active_accounts].number_of_transactions; i++) {
        // Copy transaction data
        accounts[account_index].transactions[i].amount = accounts[active_accounts].transactions[i].amount;
        accounts[account_index].transactions[i].data.year = accounts[active_accounts].transactions[i].data.year;
        accounts[account_index].transactions[i].data.month = accounts[active_accounts].transactions[i].data.month;
        accounts[account_index].transactions[i].data.day = accounts[active_accounts].transactions[i].data.day;
        strcpy(accounts[account_index].transactions[i].description, accounts[active_accounts].transactions[i].description);
        strcpy(accounts[account_index].transactions[i].type, accounts[active_accounts].transactions[i].type);
    }

    accounts[account_index].contact = malloc(15 * sizeof (struct contacts_format));     // allocate new memory for the contacts

    for(int i = 0 ; i < accounts[active_accounts].number_of_friends ; i++)      // copy the contacts
    {
        strcpy(accounts[account_index].contact[i].first_name, accounts[active_accounts].contact[i].first_name);
        strcpy(accounts[account_index].contact[i].second_name, accounts[active_accounts].contact[i].second_name);
        strcpy(accounts[account_index].contact[i].iban, accounts[active_accounts].contact[i].iban);

    }

    free(accounts[active_accounts].contact);    // free the memory
    accounts[active_accounts].contact = NULL;
    // Free the transactions for the active account
    free(accounts[active_accounts].transactions);       // free the memory
    accounts[active_accounts].transactions = NULL;
}

// function that deletes a contact and frees the occupied memory
void change_contacts(struct account *accounts, int account_index, int contact_index)
{

    struct date_format new_date;

    new_date.year = 2024;
    new_date.month = 1;
    new_date.day = 9;

    char action[50];
    strcpy(action, "Deleted contact");

    add_to_audit_log(accounts[account_index].first_name, accounts[account_index].second_name, action, accounts[account_index].contact[contact_index].first_name,"0", "0", 0, new_date );
        // save the action in the audit log
    // Free the memory for the contact to be deleted
    free(&accounts[account_index].contact[contact_index]);

    // Shift the remaining contacts to fill the gap
    for (int i = contact_index; i < accounts[account_index].number_of_friends - 1; i++) {
        strcpy(accounts[account_index].contact[i].first_name, accounts[account_index].contact[i + 1].first_name);
        strcpy(accounts[account_index].contact[i].second_name, accounts[account_index].contact[i + 1].second_name);
        strcpy(accounts[account_index].contact[i].iban, accounts[account_index].contact[i + 1].iban);
    }

    // Decrement the number of friends
    accounts[account_index].number_of_friends--;
}

//function to print the contacts of the user
void print_contacts(struct account *accounts,int account_index)
{
    printf("-----Your list of contacts-----\n");
    for(int i = 0 ; i < accounts[account_index].number_of_friends ; i++)        // print the list of contacts
    {
        printf("%d. %s %s\n", i + 1, accounts[account_index].contact[i].first_name, accounts[account_index].contact[i].second_name);
    }
}

//function to transfer money to a contact
void transaction_to_friend(struct account *accounts,int account_index)
{
    printf("To what friend do you want to transfer money?\n");

    print_contacts(accounts, account_index);    // print all the contacts

    struct transaction_format new_transaction;  // initialize new transaction

    while(1)
    {
        char input[10];
        int number = 0;
        int okay = 0;
        while(1) {
            printf("Enter your friends number!\n");     // ask for the index of their index

            scanf("%s", input);

            // Check if the input has only digits
            int i;
            for (i = 0; input[i] != '\0'; i++) {
                if (!isdigit(input[i])) {
                    printf("Error: Input contains non-digit characters.\n");
                    okay = 1;  // Exit with an error code
                    break;
                }
            }

            // Convert the input to an integer
            number = atoi(input);
            if(number > 14 || number == 0 || okay == 1)
            {
                printf("Invalid input\n");
            } else{
                number--;
                break;
            }
        }
        if(number < accounts[account_index].number_of_friends)      // check if the number is within bounderies
        {
            while(1){
                char date[11];
                printf("Enter the date of the transaction (format YYYY-MM-DD)\n"); // we ask the user to introduce a date
                scanf("%s", date);

                if(is_date_valid(date) == 1)
                {
                    if(calculate_year(date) - accounts[account_index].user_birthday.year >= 0){
                        new_transaction.data.day = calculate_day(date);
                        new_transaction.data.month = calculate_month(date);     // update the date
                        new_transaction.data.year = calculate_year(date);
                        break;
                    }
                    else {
                        printf("You can't make transactions before you were born\n"); // print error
                        return;
                    }
                }
                else
                    printf("Please enter a valid date\n");
            }

            printf("Enter the description:\n");         // ask the user to introduce a description of the transaction

            scanf(" %[^\n]s", new_transaction.description); // we read the description string until a new line is met

            char money[30];         // variable used for holding the input user , of the amount variable

            while(1)
            {
                printf("Enter the amount(will be considered only the first 2 digits of the number):\n"); // ask the user to insert the amount of the transaction

                scanf("%s", money);     // read the user input

                if(money[0] == '-')                                             // the amount cannot be negative , because we will take into account if it's a Income or expense later
                    printf("The amount entered must be a positive number\n");
                else
                if(verify_if_double(money) == -1)                         // we verify if the input has been introduced correctly
                    printf("Invalid input please enter a valid sum\n");  // repeat until the introduced value is correct
                else
                    break;
            }

            new_transaction.amount = atof(money);   // we add the amount into the new structure with the atof function

            float amount = new_transaction.amount;

            strcpy(new_transaction.to_acc_iban, accounts[account_index].contact[number].iban);
            strcpy(new_transaction.from_acc_iban, accounts[account_index].iban);        // update the transaction details
            strcpy(new_transaction.type, "Transfer-");

            char iban[23];
            strcpy(iban, accounts[account_index].contact[(number)].iban);

            int index = 0;

            for (int i = 0; i < active_accounts; i++) {

                if (strcmp(iban, accounts[i].iban) == 0) {      // search for the iban in case their contact deleted thei account
                    index = i;
                    break;
                }

            }
            //printf("%d", index);
            if(index == -1)
            {
                printf("We did not find any account with this iban! Maybe your friend deleted their account.Returning in the menu...\n"); // see if the iban exists
                return;
            }

            if (accounts[account_index].balance < new_transaction.amount) {     // check if the user has the money
                printf("You don't have that much money in your account!\n");
                return;
            } else {
                if (strcmp(accounts[account_index].account_type, "Savings") == 0) { // if the account is type of savings, the user will be penalised
                    printf("This is a savings account. For each transaction you make we will take 5 percent of the transaction value! Are you sure you want to do that?\n");
                    while (1) {
                        printf("1. Yes\n2. No\n");
                        char input_afirmation[5];
                        scanf("%s", &input_afirmation);
                        if (strlen(input_afirmation) > 1)       // verify if the command is valid, if not print error message
                            printf("Invalid command.\n");
                        else {
                            int option1 = input_afirmation[0] - '0';
                            if (option1 == 1) {
                                new_transaction.amount = new_transaction.amount + (new_transaction.amount * 5) / 100;
                                break;
                            } else {
                                return;
                            }
                        }
                    }
                }
            }
            accounts[index].transactions[accounts[index].number_of_transactions].data = new_transaction.data;
            accounts[index].transactions[accounts[index].number_of_transactions].amount = amount;       // add a new transaction for the receiver too

            strcpy(accounts[index].transactions[accounts[index].number_of_transactions].description, new_transaction.description);
            strcpy(accounts[index].transactions[accounts[index].number_of_transactions].type, "Transfer+");
            strcpy(accounts[index].transactions[accounts[index].number_of_transactions].from_acc_iban, accounts[account_index].iban);
            strcpy(accounts[index].transactions[accounts[index].number_of_transactions].to_acc_iban, accounts[index].iban);

            accounts[index].number_of_transactions = accounts[index].number_of_transactions + 1;
            accounts[index].balance = calculate_balance(accounts, index);   // update the balance

            accounts[account_index].transactions[accounts[account_index].number_of_transactions] = new_transaction;
            accounts[account_index].number_of_transactions = accounts[account_index].number_of_transactions + 1;            // add the new transaction to the account
            accounts[account_index].balance = calculate_balance(accounts, account_index);

            char action[50];
            strcpy(action, "Transfer to friend");           // add a new entry to the audit log
            add_to_audit_log(accounts[account_index].first_name, accounts[account_index].second_name, action, accounts[index].first_name, accounts[account_index].iban, accounts[index].iban, amount, new_transaction.data);

            break;
        }
        else
        {
            printf("Please enter a valid number!\n");       // print error
        }
    }
}

// function to add a new contact
void add_contact( struct account *accounts,int account_index)
{

    if(accounts[account_index].number_of_friends == 14)
    {
        printf("You have to many contacts delete one first!");      // check if the user has too many contacts
        return;
    }

    char first_name[20], second_name[20];
    while(1) {
        printf("Enter the first name of your contact:\n");      // ask how he wants to name them
        scanf("%s", first_name);
        if(check_if_name(first_name, strlen(first_name)) == 1)
        {
            break;
        }
    }

    while(1){
        printf("Enter the last name of your contact:\n");
        scanf("%s", second_name);
        if(check_if_name(second_name, strlen(second_name)) == 1)
        {
            break;
        }
    }

    while (getchar() != '\n');

    printf("Please enter the iban of your friend:\n");      // ask for their iban
    char iban[24];

    scanf("%s", iban);              // check if it exists

    int index = -1;
    for (int i = 0; i < active_accounts; i++) {

        if (strcmp(iban, accounts[i].iban) == 0) {
            index = i;
            break;
        }

    }
    //printf("%d", index);
    if(index == -1)
    {                   // if the iban does not exists return
        printf("We did not find any account with this iban! Returning in the menu...\n");
        return;
    }
    strcpy(accounts[account_index].contact[accounts[account_index].number_of_friends].first_name, first_name);
    strcpy(accounts[account_index].contact[accounts[account_index].number_of_friends].second_name, second_name);        // add the new transaction
    strcpy(accounts[account_index].contact[accounts[account_index].number_of_friends].iban, iban);

    accounts[account_index].number_of_friends = accounts[account_index].number_of_friends + 1;

    struct date_format new_date;

    new_date.year = 2024;
    new_date.month = 1;
    new_date.day = 9;

    char action[50];

    strcpy(action, "Added contact");                // add a new entry to the audit log

    add_to_audit_log(accounts[account_index].first_name, accounts[account_index].second_name, action, first_name, "0", "0", 0 , new_date);

}

// function to delete a contact
void delete_contact( struct account *accounts,int account_index)
{
    printf("Which contact do you want to delete!\n");

    char first_name[20], second_name[20];
    while(1) {
        printf("Enter the first name of your contact:\n");          // ask for the names
        scanf("%s", first_name);
        if(check_if_name(first_name, strlen(first_name)) == 1)
        {
            break;
        }
    }

    while(1){
        printf("Enter the last name of your contact:\n");
        scanf("%s", second_name);
        if(check_if_name(second_name, strlen(second_name)) == 1)
        {
            break;
        }
    }

    for (int i = 0 ; i < accounts[account_index].number_of_friends ; i++)
    {
        if(strcmp(accounts[account_index].contact[i].first_name, first_name) == 0 && strcmp(accounts[account_index].contact[i].second_name, second_name) == 0)
        {
            printf("Are you sure you want to delete this contact? Type CONFIRM\n"); // make sure that the user wants to do that
            char input[20];
            scanf("%s", input);
            if(strcmp(input, "CONFIRM") == 0)
            {
                change_contacts(accounts, account_index, i);        // delete the contact

            }
            else{
                return;
            }
        }
    }

}

// function to delete the account
void delete_account( struct account *accounts,int account_index)
{
    printf("Are you sure you want to delete your account?\n");
    printf("Please type the text CONFIRM if you want to delete your account\n");  // make sure that the user wants to do that

    printf(">");

    char text[10];

    scanf("%s", text);

    if(strcmp(text, "CONFIRM") == 0)
    {
        change_accounts(accounts, account_index);
        printf("You successfully deleted your account!\n");       // delete the account from the data base
        active_accounts--;
        return;
    }

    return;
}

// function to do a financial report
void financial_report( struct account *accounts,int account_index)
{
    if(accounts[account_index].number_of_transactions == 0) // check if there are no transactions made
    {
        printf("There is no transaction made until this moment. Please insert a transaction first!\n");
        return;
    }
    printf("Between what dates do you want a financial report for?\n"); // ask user for input

    char first_date[15], second_date[15];   // variables to hold the two dates

    while(1)
    {
        printf("Enter the beginning date(format YYYY-MM-DD):\n");   // ask the user for beginning date

        scanf("%s", first_date);        // read the beginning date

        if(is_date_valid(first_date) == 1)      // we verify if the date is valid
        {
            break;
        }
        else
            printf("Please enter a valid date of the format YYYY-MM-DD\n"); // if the date is not valid print an error
    }

    int year_first_date = calculate_year(first_date);
    int month_first_date = calculate_month(first_date); // transform the string of the beginning date into integers, year , month , day
    int day_first_date = calculate_day(first_date);

    while(1)
    {
        printf("Enter the ending date(format YYYY-MM-DD):\n");  // ask the user for the end date

        scanf("%s", second_date);   // read the end date

        if(is_date_valid(second_date) == 1)     // we verify if the date is valid
        {
            int year_second_date = calculate_year(second_date);
            int month_second_date = calculate_month(second_date);       // transform the string of the end date into integers , year , month , day
            int day_second_date = calculate_day(second_date);

            if(compare_dates(year_first_date, month_first_date, day_first_date,
                             year_second_date, month_second_date, day_second_date) == -1)    // verify if the end date is greater than the beginning date
            {
                break;
            }
            else
            {
                printf("Please enter a date that is greater than the beginning date!\n"); // if the end date is smaller than the beginning date print error message
            }
        }
        else
            printf("Please enter a valid date of the format YYYY-MM-DD\n");     // print error if the date is not valid
    }

    int year_second_date = calculate_year(second_date);
    int month_second_date = calculate_month(second_date);   // transform the string of the end date into integers , year , month , day
    int day_second_date = calculate_day(second_date);



    float expenses = 0;        // initialize the income and expenses of all the transactions
    float incomes = 0;

    for( int i = 0 ; i < accounts[account_index].number_of_transactions ; i++)
    {
        int year = accounts[account_index].transactions[i].data.year;
        int month = accounts[account_index].transactions[i].data.month;
        int day = accounts[account_index].transactions[i].data.day;

        if(is_between_dates(year_first_date, month_first_date, day_first_date,
                            year_second_date, month_second_date, day_second_date, year, month, day) == 1)
        {                                         // verify if the current transaction is between the dates asked by the user
            if(strcmp(accounts[account_index].transactions[i].type, "Deposit") == 0)
                incomes = incomes + accounts[account_index].transactions[i].amount;

            if(strcmp(accounts[account_index].transactions[i].type, "Transfer+") == 0)
                incomes = incomes + accounts[account_index].transactions[i].amount;

            if(strcmp(accounts[account_index].transactions[i].type, "Interest Rate") == 0)      // according to the type of the transaction add it to expenses or incomes
                incomes = incomes + accounts[account_index].transactions[i].amount;

            if(strcmp(accounts[account_index].transactions[i].type, "Withdraw") == 0)
                expenses = expenses + accounts[account_index].transactions[i].amount;

            if(strcmp(accounts[account_index].transactions[i].type, "Transfer-") == 0)
                expenses = expenses + accounts[account_index].transactions[i].amount;

            if(strcmp(accounts[account_index].transactions[i].type, "Payment") == 0)
                expenses = expenses + accounts[account_index].transactions[i].amount;
        }
    }

    printf("For the period %s", first_date);    // print the incomes and expenses of the given period of time

    printf(" - ");

    printf("%s\n", second_date);

    printf("The income is %lf\n", incomes);

    printf("The expenses are %lf\n", expenses);

}

// print transaction history
void transaction_history( struct account *accounts,int account_index)
{
    printf("------Your transaction history------");

    for( int i = 0 ; i < accounts[account_index].number_of_transactions ; i++) // print the according data for the transactions
    {
        printf("%d. Type: %s\n   Amount: %f\n   The date: %d/%d/%d\n   Description: %s\n   From the iban: %s\n   To the account iban: %s\n", i + 1,
               accounts[account_index].transactions[i].type, accounts[account_index].transactions[i].amount, accounts[account_index].transactions[i].data.day,
               accounts[account_index].transactions[i].data.month, accounts[account_index].transactions[i].data.year,
               accounts[account_index].transactions[i].description,
               accounts[account_index].transactions[i].from_acc_iban, accounts[account_index].transactions[i].to_acc_iban);
    }
}

//function to print the audit log
void printAuditLog(struct audit_log *log) {
    for (int i = 0; i < audit_length; i++) {
        printf("First Name: %s\n", log[i].first_name);
        printf("Second Name: %s\n", log[i].second_name);
        printf("Action: %s\n", log[i].action);                  // print the audit log with it's details
        printf("Transfer From: %s\n", log[i].transfer_from);
        printf("Transfer To: %s\n", log[i].transfer_to);
        printf("Additional Description: %s\n", log[i].additional_description);
        printf("Date: %d-%02d-%02d\n", log[i].date.year, log[i].date.month, log[i].date.day);
        printf("Amount: %.2f\n", log[i].amount);
        printf("----------------------------------\n");
    }
}

// function to tackle what user can do
void in_login_ui( struct account *accounts,int account_index)
{
    printf("        Welcome back!\n");
    while(1) {
        print_user_options();
        if(accounts[account_index].is_administrator == 1)
            printf("13. View log\n");
        char input[100];        // initialize the option

        printf("Enter your option\n");  // ask the user for input

        scanf("%s", &input);        // read the input

        if(strlen(input) > 2)       // verify if the command is valid , if not print error message
            printf("Invalid command. Please Please enter a number between 1 and 12\n");
        else{
            int option;
            if(strlen(input) == 1)
            {
                option = input[0] - '0';        // transform the string of the option in integer
            }
            else{
                option = (input[0] - '0') * 10 + input[1] - '0';
            }

            switch (option) {               // do what the user wants to
                case 1:                     // show account details
                    account_details(accounts, account_index);
                    break;
                case 2:                 // add a new transaction
                    add_transaction(accounts, account_index);
                    //printf("%d", accounts[account_index].number_of_transactions);
                    break;
                case 3:
                    printf("Your balance is %f\n", accounts[account_index].balance);        // print the balance
                    break;
                case 4:
                    edit_account(accounts, account_index);          // edit account details
                    break;
                case 5:
                    delete_account(accounts, account_index);        // delete the account
                    return;
                case 6:
                    financial_report(accounts, account_index);      // do a financial report
                    break;
                case 7:
                    transaction_history(accounts, account_index);       // print transaction history
                    break;
                case 8:
                    print_contacts(accounts, account_index);        // print the contacts
                    break;
                case 9:
                    add_contact(accounts, account_index);           // add a new contact
                    break;
                case 10:
                    delete_contact(accounts, account_index);            // delete a contact
                    break;
                case 11:
                    transaction_to_friend(accounts, account_index);     // transaction to account
                    break;
                case 12:                            // log out
                    return;
                case 13:
                    if(accounts[account_index].is_administrator == 1)   // if the account is administrator the user can print the audit
                    {
                        printAuditLog(auditLog);
                    }
                    break;
                default:
                    printf("Invalid option");
            }
        }
    }
}

//function to register the account
void register_account( struct account *accounts)
{
    while(1) {
        printf("Enter your first name:\n");     // ask for the first name
        char first_name[20];
        scanf("%s", first_name);
        if(check_if_name(first_name, strlen(first_name)) == 1)      // verify it
        {
            strcpy(accounts[active_accounts].first_name, first_name);
            break;
        }
    }

    while(1){
        printf("Enter your last name:\n");      // ask for the last name
        char second_name[20];
        scanf("%s", second_name);
        if(check_if_name(second_name, strlen(second_name)) == 1)        // verify it
        {
            strcpy(accounts[active_accounts].second_name, second_name);
            break;
        }
    }

    while (getchar() != '\n'); // clear buffer

    int is_not_18 = 0;

    while(1){
        char date[11];
        printf("Enter your birthday (format YYYY-MM-DD)\n"); // we ask the user to introduce a date
        scanf("%s", date);

        if(is_date_valid(date) == 1)
        {
            if(2024 - calculate_year(date) > 18 || 2024 - calculate_year(date) == 18 && calculate_month(date) == 1 && calculate_day(date) <= 4){    // verify if the user is 18
                accounts[active_accounts].user_birthday.day = calculate_day(date);
                accounts[active_accounts].user_birthday.month = calculate_month(date);
                accounts[active_accounts].user_birthday.year = calculate_year(date);
                break;
            }
            else {
                printf("You must be 18 to create a bank account\n");        // if not exit the function
                return;
            }
        }
        else
            printf("Please enter a valid birthday\n");  // print error
    }

    while (getchar() != '\n');// clear buffer

    while(1){
        printf("Enter your password\n"); // ask for password
        char password[30];
        fgets(password, sizeof(password), stdin);

        // Remove the newline character from the password
        size_t len = strlen(password);
        if (len > 0 && password[len - 1] == '\n') {
            password[len - 1] = '\0';
        }

        int capital = 0, special = 0, normal = 0, spaces = 0;
        if(strlen(password) < 5 || strlen(password) > 30)
            printf("The length of the password must be between 5 and 30!\n");       // ask for the user to make a harder password to guess
        else {
            for (int i = 0; i < strlen(password); i++) {
                if (password[i] >= 'a' && password[i] <= 'z')
                    normal++;
                else if (password[i] >= 'A' && password[i] <= 'Z')
                    capital++;
                else if (password[i] == ' ')
                    spaces++;
                else
                    special++;
            }
            if (special == 0 || normal == 0 || capital == 0 || spaces > 0)
                printf("The password must contain at least one capital letter, one lower case letter, one special character and must not contain spaces\n");
            else {
                strcpy(accounts[active_accounts].password, password);
                break;
            }
        }
    }

    while(1){
        printf("Are you an administrator?\n");  // see if the user is the administrator
        printf(">Yes\n>No\n");
        char input[5];
        scanf("%s", input);

        if(strcmp(input, "Yes") == 0)           // ask for the passkey
        {
            int number_attempts = 0;
            while(1)
            {
                if(number_attempts == 3)
                {
                    printf("You entered the wrong passkey too many times. Your account will not have the administrator features!\n");
                    break;
                }

                number_attempts++;

                printf("Enter the administrator passkey:\n");
                char passkey_input[10];

                scanf("%s", passkey_input);

                if(strcmp(passkey_input, "PT09CL06") == 0)
                {
                    accounts[active_accounts].is_administrator = 1;     // if it has it give him the grade
                    break;
                }
                else{
                    printf("Wrong passkey! You have %d attempts left\n", 3 - number_attempts);
                }
            }
            break;
        }
        else
        if(strcmp(input, "No") == 0)
        {
            accounts[active_accounts].is_administrator = 0;
            break;
        }
        else{
            printf("Invalid input!\n");
        }
    }

    while(1){           // ask what kind of account does he want to have
        printf("What type of account do you want to create?\n");
        printf("1. Savings account\n");
        printf("2. Checking account\n");
        printf("3. Credit account\n");

        char input[10];

        printf("Enter your option:");

        scanf("%s", input);

        if(input[0] - '0' < 4 && input[0] - '0' > 0)
        {
            if(input[0] - '0' == 1)
                strcpy(accounts[active_accounts].account_type, "Savings");

            if(input[0] - '0' == 2)
                strcpy(accounts[active_accounts].account_type, "Checkings");        // update the account details

            if(input[0] - '0' == 3)
                strcpy(accounts[active_accounts].account_type, "Credit");
            break;
        }
        else
            printf("Invalid option\n");
    }

    accounts[active_accounts].transactions = malloc(100 * sizeof(struct transaction_format));       // allocate the necesary memory
    accounts[active_accounts].contact = malloc(15 * sizeof (struct contacts_format));

    accounts[active_accounts].iban[0] = 'R';
    accounts[active_accounts].iban[1] = 'O';

    int sum = calculate_sum_of_digits(num_accounts);

    if (sum > 99)
        sum = calculate_sum_of_digits(sum);

    accounts[active_accounts].iban[2] = (sum / 10) + '0';
    accounts[active_accounts].iban[3] = (sum % 10) + '0';           // generate the iban

    accounts[active_accounts].iban[4] = 'L';
    accounts[active_accounts].iban[5] = 'C';
    accounts[active_accounts].iban[6] = 'F';
    accounts[active_accounts].iban[7] = 'A';

    int aux = active_accounts;
    int index = 22;

    accounts[active_accounts].iban[index + 1] = '\0';

    while (aux)
    {
        accounts[active_accounts].iban[index] = (aux % 10) + '0';
        index--;
        aux = aux / 10;
    }

    for (int i = index ; i >= 8 ; i--)
        accounts[active_accounts].iban[i] = '0';

    printf("Your iban is:");        // print the iban

    for (int  i = 0 ; i <= 23 ; i++)
        printf("%c",accounts[active_accounts].iban[i]);

    char action[50];

    strcpy(action, "Register account");
                                                                    // add a new entry to the audit log
    add_to_audit_log(accounts[active_accounts].first_name,accounts[active_accounts].second_name, action,"0", "0", "0", 0, accounts[active_accounts].user_birthday);
    printf("\n");

}

// function that does the login
void login( struct account *accounts)
{
    char first_name[20], second_name[20];
    while(1) {
        printf("Enter your first name:\n"); // ask for the user details
        scanf("%s", first_name);
        if(check_if_name(first_name, strlen(first_name)) == 1)
        {
            break;
        }
    }

    while(1){
        printf("Enter your last name:\n");          // for name
        scanf("%s", second_name);
        if(check_if_name(second_name, strlen(second_name)) == 1)
        {
            break;
        }
    }

    while (getchar() != '\n'); // clean buffer

    for (int i = 0 ; i < active_accounts ; i++)
    {
        if (strcmp(accounts[i].first_name, first_name) == 0 && strcmp(accounts[i].second_name, second_name) == 0)       // also for password
        {
            int num_attempts = 0;
            while(1)
            {
                if (num_attempts == 5)      // if the number of attempts is reached return
                {
                    printf("You are a robot! You made too many mistakes entering your password. ACCESS DENIED!!!\n");       // the user can enter the password a limited number of times
                    return;
                }
                printf("Enter your password:\n");
                char input_password[30];
                fgets(input_password, 30, stdin);
                size_t len = strlen(input_password);
                if (len > 0 && input_password[len - 1] == '\n') {
                    input_password[len - 1] = '\0';
                }
                if(strcmp(accounts[i].password, input_password) == 0) {     // if the password is correct, grand acces
                    printf("You successfully logged in!\n");
                    in_login_ui(accounts, i);
                    return ;
                }
                else
                {
                    num_attempts++;
                    printf("Wrong password! You have %d attempts left\n", 5 - num_attempts); // add one for each attempt
                }

            }
        }

    }
    printf("Error! We couldn't find your name in our database.\n"); // print error

}

// function that saves the data in a csv file
void exportDataToCSV(struct account *accounts, int numAccounts) {
    FILE *file = fopen("data.csv", "w");  // Open the CSV file for writing

    if (file == NULL) {
        printf("Error opening file for writing.\n");
        return;
    }

    // Write each account's data to the CSV file
    for (int i = 0; i < numAccounts; i++) {
        fprintf(file, "First Name,Second Name,Password,Account Type,Is administrator,Balance,IBAN,User Birthday,Number of Transactions,Number of friends\n");
        fprintf(file, "%s,%s,%s,%s,%d,%.2f,%s,%d-%d-%d,%d,%d\n",
                accounts[i].first_name, accounts[i].second_name,
                accounts[i].password, accounts[i].account_type, accounts[i].is_administrator,   // complete with details about the account
                accounts[i].balance, accounts[i].iban,
                accounts[i].user_birthday.year, accounts[i].user_birthday.month,
                accounts[i].user_birthday.day, accounts[i].number_of_transactions,
                accounts[i].number_of_friends);

        fprintf(file, "Transaction Type,Transaction Amount,Transaction Description,From Account IBAN,To Account IBAN,Transaction Date\n");
        // Write transaction data
        for (int j = 0; j < accounts[i].number_of_transactions; j++) {
            fprintf(file, "%s,%f,%s,%s,%s,%d/%d/%d\n",
                    accounts[i].transactions[j].type,
                    accounts[i].transactions[j].amount,
                    accounts[i].transactions[j].description,
                    accounts[i].transactions[j].from_acc_iban,          // complete with details about the transactions
                    accounts[i].transactions[j].to_acc_iban,
                    accounts[i].transactions[j].data.day,
                    accounts[i].transactions[j].data.month,
                    accounts[i].transactions[j].data.year);
        }

        fprintf(file, "First name,Last name,IBAN\n");

        // Write contact data
        for (int k = 0; k < accounts[i].number_of_friends; k++) {
            if(k < accounts[i].number_of_friends - 1) {
                fprintf(file, "%s,%s,%s\n",
                        accounts[i].contact[k].first_name,          // complete with details about the contacts
                        accounts[i].contact[k].second_name,
                        accounts[i].contact[k].iban);
            }
            else
            {                fprintf(file, "%s,%s,%s",
                                     accounts[i].contact[k].first_name,
                                     accounts[i].contact[k].second_name,
                                     accounts[i].contact[k].iban);}

        }

    }

    fclose(file);  // Close the CSV file
}

//function that imports the data from a csv file
void importDataFromCSV(struct account *accounts, int *numAccounts) {
    FILE *file = fopen("data.csv", "r");  // Open the CSV file for reading

    if (file == NULL) {
        printf("Error opening file for reading.\n");
        return;
    }

    int active_accounts1 = 0;
    char line[500];

    while (fgets(line, sizeof(line), file) != NULL) {
            // Read account data
            fgets(line, sizeof(line), file);
        sscanf(line, "%99[^,],%99[^,],%99[^,],%99[^,],%d,%f,%99[^,],%d-%d-%d,%d,%d",
                   accounts[active_accounts1].first_name, accounts[active_accounts1].second_name,
                   accounts[active_accounts1].password, accounts[active_accounts1].account_type,
                   &accounts[active_accounts1].is_administrator, &accounts[active_accounts1].balance,
                   accounts[active_accounts1].iban, &accounts[active_accounts1].user_birthday.year,                 // take the details about the accounts
                   &accounts[active_accounts1].user_birthday.month, &accounts[active_accounts1].user_birthday.day,
                   &accounts[active_accounts1].number_of_transactions,
                   &accounts[active_accounts1].number_of_friends);
            // Allocate memory for transactions and contacts only if not already allocated
            if (accounts[active_accounts1].transactions == NULL) {
                accounts[active_accounts1].transactions = malloc(accounts[active_accounts1].number_of_transactions * sizeof(struct transaction_format));
            }

            if (accounts[active_accounts1].contact == NULL) {
                accounts[active_accounts1].contact = malloc(accounts[active_accounts1].number_of_friends * sizeof(struct contacts_format));
            }
            fgets(line, sizeof(line), file);

            // Read transaction data
            for (int i = 0; i < accounts[active_accounts1].number_of_transactions; i++) {
                fgets(line, sizeof(line), file);
                //printf("%s", line);
                sscanf(line, "%99[^,],%f,%99[^,],%99[^,],%99[^,],%d/%d/%d",
                       accounts[active_accounts1].transactions[i].type,
                       &accounts[active_accounts1].transactions[i].amount,
                       accounts[active_accounts1].transactions[i].description,
                       accounts[active_accounts1].transactions[i].from_acc_iban,                // take the details about the transactions
                       accounts[active_accounts1].transactions[i].to_acc_iban,
                       &accounts[active_accounts1].transactions[i].data.day,
                       &accounts[active_accounts1].transactions[i].data.month,
                       &accounts[active_accounts1].transactions[i].data.year);
                //printf("%d", accounts[active_accounts1].transactions[i].data.year);

            }

        fgets(line, sizeof(line), file);

        // Read contact data
            for (int i = 0; i < accounts[active_accounts1].number_of_friends; i++) {
                fgets(line, sizeof(line), file);
                //printf("%s", line);
                sscanf(line, "%99[^,],%99[^,],%99[^,]",
                       accounts[active_accounts1].contact[i].first_name,
                       accounts[active_accounts1].contact[i].second_name,
                       accounts[active_accounts1].contact[i].iban);
            }

            (*numAccounts)++;
            active_accounts1++;

    }

    fclose(file);  // Close the CSV file
}

//function that loads from the audit file
int readAuditLogFromFile(struct audit_log *log) {
    FILE *file = fopen("audit.txt", "r");  // Open the file for reading

    if (file == NULL) {
        printf("Error opening file for reading.\n");
        return 0;
    }

    int entriesRead = 0;
    char line[1000];

    while (fgets(line, sizeof(line), file) != NULL) {

        sscanf(line, "First Name: %s", log[entriesRead].first_name);
        //printf("%s", log[entriesRead].first_name);
            fgets(line, sizeof(line), file);
            sscanf(line, "Second Name: %s", log[entriesRead].second_name);

            fgets(line, sizeof(line), file);
            sscanf(line, "Action: %s", log[entriesRead].action);                // read all the details of the logs

            fgets(line, sizeof(line), file);
            sscanf(line, "Transfer From: %s", log[entriesRead].transfer_from);

            fgets(line, sizeof(line), file);
            sscanf(line, "Transfer To: %s", log[entriesRead].transfer_to);

            fgets(line, sizeof(line), file);
            sscanf(line, "Additional Description: %s", log[entriesRead].additional_description);

            fgets(line, sizeof(line), file);
            sscanf(line, "Date: %d-%02d-%02d", &log[entriesRead].date.year,
                   &log[entriesRead].date.month, &log[entriesRead].date.day);

            fgets(line, sizeof(line), file);
            sscanf(line, "Amount: %f", &log[entriesRead].amount);

            entriesRead++;

    }

    fclose(file);
    audit_length = entriesRead;
}

//write the details of the audit log form the file
void clearAndWriteAuditLogToFile(const struct audit_log *log) {
    FILE *file = fopen("audit.txt", "w");  // Open the file in write mode

    if (file == NULL) {
        printf("Error opening file for writing.\n");
        return;
    }

    // Write data to the file
    for (int i = 0; i < audit_length; i++) {
        fprintf(file, "First Name: %s\n", log[i].first_name);
        fprintf(file, "Second Name: %s\n", log[i].second_name);
        fprintf(file, "Action: %s\n", log[i].action);           // write all the necesary data
        fprintf(file, "Transfer From: %s\n", log[i].transfer_from);
        fprintf(file, "Transfer To: %s\n", log[i].transfer_to);
        fprintf(file, "Additional Description: %s\n", log[i].additional_description);
        fprintf(file, "Date: %d-%02d-%02d\n", log[i].date.year, log[i].date.month, log[i].date.day);
        fprintf(file, "Amount: %.2f\n", log[i].amount);
    }

    fclose(file);
}

int main() {

    printf("----Managing Financial Data App----\n");        // print the app title

    printf("Welcome to the World Finance Bank! How can we help you?\n\n"); // print welcome message

    struct account *accounts = malloc(100 * sizeof(struct account));

    while(1)
    {

        print_menu();
        int *ptr_active_accounts = 0;

        char input[100];        // initialize the option

        printf("Enter your option\n");  // ask the user for input

        scanf("%s", &input);        // read the input

        if(strlen(input) > 1)       // verify if the command is valid , if not print error message
            printf("Invalid command. Please Please enter a number between 1 and 5\n");
        else
        {
            int option = input[0] - '0';        // transform the string of the option in integer
            switch(option)          // do the action the user asked for
            {
                case 1:
                    login(accounts);            // login
                    break;
                case 2:
                    register_account(accounts);         // register account
                    active_accounts = active_accounts + 1;
                    num_accounts = num_accounts + 1;
                    break;
                case 3:
                    exportDataToCSV(accounts, active_accounts);     // export data to cvs
                    clearAndWriteAuditLogToFile(auditLog);
                    num_accounts = active_accounts;
                    break;
                case 4:
                    importDataFromCSV(accounts, &active_accounts);      // import data from cvs
                    readAuditLogFromFile(auditLog);
                    break;
                case 5:
                    printf("Thank you for using our services! We hope that you will come back! Have a great day!\n");       // print exit message
                    free(accounts);     // free the memory
                    exit(0);

                default:
                    printf("Invalid choice. Please enter a number between 1 and 5\n");  // if the user's option is not valid print error message
            }
        }
    }

    return 0;
}
//PT09CL06  // the administrator passkey
